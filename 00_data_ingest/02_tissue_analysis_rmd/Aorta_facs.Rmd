---
title: "Aorta facs Notebook"
output:
  html_document: default
  html_notebook: default
---

Specify the tissue of interest, run the boilerplate code which sets up the functions and environment, load the tissue object.

```{r}
tissue_of_interest = "Aorta"
library(here)
source(here("00_data_ingest", "02_tissue_analysis_rmd", "boilerplate.R"))
tiss <- load_tissue_facs(tissue_of_interest)
```

```{r, echo=FALSE, fig.height=4, fig.width=8}
PCHeatmap(object = tiss, pc.use = 1:3, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 8)
```

```{r}
PCElbowPlot(object = tiss)
```

```{r}
# Set number of principal components. 
n.pcs = 15
```

```{r}
# Set resolution 
res.used <- 1.5

tiss <- FindClusters(object = tiss, reduction.type = "pca", dims.use = 1:n.pcs, 
    resolution = res.used, print.output = 0, save.SNN = TRUE)
```

```{r}
tiss <- RunTSNE(object = tiss, dims.use = 1:n.pcs, seed.use = 10, perplexity=30)
```

```{r}
# note that you can set do.label=T to help label individual clusters
TSNEPlot(object = tiss, do.label = T)
```

```{r}
# Batch and animal effects
TSNEPlot(object = tiss, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = tiss, do.return = TRUE, group.by = "mouse.id")
```

```{r}
FeaturePlot(tiss, "Alas2")
FeaturePlot(tiss, "Pecam1")
FeaturePlot(tiss, "H2-Aa")
FeaturePlot(tiss, "H2-Ab1")
```


Check expression of genes of interset.

```{r, echo=FALSE, fig.height=12, fig.width=8}
genes_to_check = c('Vim','Krt5','Krt8','Ptprc','Epcam','H2-Ab1','H2-Aa','Cd34','Cdh5','Cd14','Vwf','Syk','Col1a2','Timp2','Cd74',
                   'Laptm5','Selplg','Pecam1','Fabp4','Sox18','Icam1','Tek','Vcam1','Vegfa','Adipor1','Car3','Alas2','Acta2',
                   'Dcn','Myocd','Tagln','Myh11','S100a4','Cd3e','Pdgfra','Kit','Gypa','Col6a3','Fap')
FeaturePlot(tiss, genes_to_check, pt.size = 1, nCol = 3)
```

Dotplots let you see the intensity of expression and the fraction of cells expressing for each of your genes of interest.

```{r, echo=FALSE, fig.height=8, fig.width=8}
# To change the y-axis to show raw counts, add use.raw = T.
#DotPlot(tiss, genes_to_check, col.max = 2.5, plot.legend = T, do.return = T) + coord_flip()
VlnPlot(tiss, genes_to_check)
```

How big are the clusters?
```{r}
table(tiss@ident)
```

Which markers identify a specific cluster?
```{r}
#clust.markers <- FindMarkers(object = tiss, ident.1 = 3, only.pos = TRUE, min.pct = 0.25, thresh.use = 0.25)
#print(x = head(x= clust.markers, n = 10))
```

## Assigning cell type identity to clusters

At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:

```{r}
# stash current cluster IDs
tiss <- StashIdent(object = tiss, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- c(0, 1,2,3,4,5)
free_annotation <- c("red blood cells", 
                     "endothelial cells_1",
                     "endothelial cells_2",
                     "fibroblasts",
                     "antigen presenting cells",
                     "endothelial cells_3")

cell_ontology_class <-c("erythrocyte",
                        "endothelial cell", 
                        "endothelial cell",
                        "fibroblast",
                        "professional antigen presenting cell",
                        "endothelial cell")

tiss <- stash_annotations(tiss, cluster.ids, free_annotation, cell_ontology_class)
```

```{r}
TSNEPlot(object = tiss, do.label = TRUE, pt.size = 0.5, group.by='free_annotation')
```

# Save the Robject for later
When you save the annotated tissue, please give it a name.

```{r}
filename = here('00_data_ingest', '04_tissue_robj_generated', 
                     paste0("facs_", tissue_of_interest, "_seurat_tiss.Robj"))
print(filename)
save(tiss, file=filename)
```

```{r}
# To reload a saved object
# filename = here('00_data_ingest', '04_tissue_robj_generated', 
#                      paste0("facs", tissue_of_interest, "_seurat_tiss.Robj"))
# load(file=filename)
```

# Export the final metadata

So that Biohub can easily combine all your cell_ontology_classs, please export them as a simple csv.

```{r}
head(tiss@meta.data)
```

```{r}
filename = here('00_data_ingest', '03_tissue_annotation_csv', 
                     paste0(tissue_of_interest, "_facs", "_annotation.csv"))
write.csv(FetchData(tiss, c('plate.barcode','cell_ontology_class', 'free_annotation', 'tSNE_1', 'tSNE_2')), file=filename)
```

# Figures for Supplement


Write the cell ontology and free annotations to CSV.

```{r}
save_annotation_csv(tiss, tissue_of_interest, "facs")
```
