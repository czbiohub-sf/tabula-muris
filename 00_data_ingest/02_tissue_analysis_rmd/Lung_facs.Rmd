---
title: "Lung FACS Notebook"
output:
  html_document: default
  html_notebook: default
---

Specify the tissue of interest, run the boilerplate code which sets up the functions and environment, load the tissue object.

```{r}
tissue_of_interest = "Lung"
library(here)
source(here("00_data_ingest", "02_tissue_analysis_rmd", "boilerplate.R"))
tiss <- load_tissue_facs(tissue_of_interest)
```
Visualize top genes in principal components

```{r, echo=FALSE, fig.height=4, fig.width=8}
PCHeatmap(object = tiss, pc.use = 10:20, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 8)
```

```{r}
PCElbowPlot(object = tiss)
```

```{r}
# Set number of principal components. 
n.pcs = 20
```

```{r}
# Set resolution 
res.used <- 3

tiss <- FindClusters(object = tiss, reduction.type = "pca", dims.use = 1:n.pcs, 
    resolution = res.used, print.output = 0, save.SNN = TRUE)
```

```{r}
tiss <- RunTSNE(object = tiss, dims.use = 1:n.pcs, seed.use = 10, perplexity=30)
```

```{r}
# note that you can set do.label=T to help label individual clusters
TSNEPlot(object = tiss, do.label = T)
```

```{r}
# Batch and animal effects
TSNEPlot(object = tiss, do.return = TRUE, group.by = "plate.barcode")
TSNEPlot(object = tiss, do.return = TRUE, group.by = "mouse.id")
```

Check expression of genes of interset.

```{r, echo=FALSE, fig.height=50, fig.width=8}
genes_to_check = c('Pecam1', 'Epcam', 'Col1a1', 'Ptprc', 'Sftpb', 'Foxj1', 'Ager', 'Scgb1a1', 'Resp18', 'Calca', 'Scgb3a2', 'Pdpn', 'Wnt3a', 'Krt5', 'Cd8a', 'Cd79a', 'Klrb1c', 'Cd3e', 'Csf1r', 'Itgax', 'Ly6c2', 'H2-Aa', 'Marco', 'Itgax', 'Mrc1', 'Itgax', 'Cd24a', 'Cd68', 'Cx3cr1', 'Cd14', 'Itgam', 'Il3ra', 'Cd14', 'Cd19', 'Ccr2', 'Cd200r3')
FeaturePlot(tiss, genes_to_check, pt.size = 1, nCol = 2, cols.use = c('grey', 'red'))
```

Dotplots let you see the intensity of expression and the fraction of cells expressing for each of your genes of interest.

```{r, echo=FALSE, fig.height=8, fig.width=8}
# To change the y-axis to show raw counts, add use.raw = T.
DotPlot(tiss, unique(genes_to_check), col.max = 2.5, plot.legend = T, do.return = T) + coord_flip()
```

How big are the clusters?
```{r}
table(tiss@ident)
```

Which markers identify a specific cluster?
```{r}
#clust.markers <- FindMarkers(object = tiss, ident.1 = 3, only.pos = TRUE, min.pct = 0.25, thresh.use = 0.25)
#print(x = head(x= clust.markers, n = 10))
```



## Assigning cell type identity to clusters

At a coarse level, we can use canonical markers to match the unbiased clustering to known cell types:

```{r}
# stash current cluster IDs
tiss <- StashIdent(object = tiss, save.name = "cluster.ids")

# enumerate current cluster IDs and the labels for them
cluster.ids <- 0:22
free_annotation <- c(NA,
                     NA,
                     NA,
                     NA,
                     NA,
                     "alveolar epithelial type 1 cells, alveolar epithelial type 2 cells, club cells, and basal cells",
                     NA,
                     "invading monocytes",
                     "dendritic cells, alveolar macrophages, and interstital macrophages",
                     NA,
                     NA,
                     "circulating monocytes",
                     NA,
                     NA,
                     NA,
                     NA,
                     NA,
                     "lung neuroendocrine cells and unknown cells",
                     NA,
                     NA,
                     "mast cells and unknown immune cells",
                     NA,
                     "multiciliated cells")


cell_ontology_class <-c("lung endothelial cell",
                     "lung endothelial cell",
                     "stromal cell",
                     "lung endothelial cell",
                     "lung endothelial cell",
                     "epithelial cell of lung",
                     "stromal cell",
                     "classical monocyte",
                     "myeloid cell",
                     "stromal cell",
                     "lung endothelial cell",
                     "monocyte",
                     "lung endothelial cell",
                     "B cell",
                     "T cell",
                     "stromal cell",
                     "stromal cell",
                     NA,
                     "lung endothelial cell",
                     "natural killer cell",
                     "leukocyte",
                     "stromal cell",
                     "ciliated columnar cell of tracheobronchial tree")

# tiss = stash_annotations(tiss, cluster.ids, free_annotation, cell_ontology_class)
```

```{r}
data.frame(cell_ontology_class, free_annotation)
```


```{r}
TSNEPlot(object = tiss, do.return = TRUE, group.by = "free_annotation", do.label = T, no.legend = T)
TSNEPlot(object = tiss, do.return = TRUE, group.by = "cell_ontology_class", do.label = T, no.legend = T)
```

## Subcluster

```{r}
subtiss = SubsetData(tiss, ident.use = c(5,17,22))
```

```{r}
subtiss <- subtiss %>% ScaleData() %>% 
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r}
PCHeatmap(object = subtiss, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 8)
PCElbowPlot(subtiss)
```


```{r}
sub.n.pcs = 10
sub.res.use = 1
subtiss <- subtiss %>% FindClusters(reduction.type = "pca", dims.use = 1:sub.n.pcs, 
    resolution = sub.res.use, print.output = 0, save.SNN = TRUE) %>%
    RunTSNE(dims.use = 1:sub.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = subtiss, do.label = T, pt.size = 1.2, label.size = 4)

```


```{r, echo=FALSE, fig.height=20, fig.width=8}

genes_to_check = c('Pecam1', 'Epcam', 'Col1a1', 'Ptprc', 'Sftpb', 'Foxj1', 'Ager', 'Scgb1a1', 'Resp18', 'Calca', 'Scgb3a2', 'Pdpn', 'Wnt3a')

FeaturePlot(subtiss, genes_to_check, pt.size = 1, nCol = 2, cols.use = c('grey', 'red'))

```

```{r, echo=FALSE, fig.height=8, fig.width=10}
DotPlot(subtiss, unique(genes_to_check), col.max = 2.5, plot.legend = T, do.return = T) + coord_flip()
```

Epithelial clusters (besides Type II and Ciliated, where n is sufficently high) do not align with known marker gene expression because of low numbers. Cannot subcluster further!


## Subcluster Myeloid cells

```{r}
subtiss2 = SubsetData(tiss, ident.use = c(8, 7, 11))
```

```{r}
subtiss2 <- subtiss2 %>% ScaleData() %>% 
  FindVariableGenes(do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 1, x.low.cutoff = 0.5) %>%
  RunPCA(do.print = FALSE) %>% ProjectPCA(do.print = FALSE)
```

```{r}
PCHeatmap(object = subtiss2, pc.use = 1:9, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 8)
PCElbowPlot(subtiss2)
```


```{r}
sub2.n.pcs = 13
sub2.res.use = 2
subtiss2 <- subtiss2 %>% FindClusters(reduction.type = "pca", dims.use = 1:sub2.n.pcs, 
    resolution = sub2.res.use, print.output = 0, save.SNN = TRUE) %>%
    RunTSNE(dims.use = 1:sub2.n.pcs, seed.use = 10, perplexity=30)

TSNEPlot(object = subtiss2, do.label = T, pt.size = 1.2, label.size = 4)

```


```{r, echo=FALSE, fig.height=25, fig.width=8}

genes_to_check = c('Pecam1', 'Epcam', 'Col1a1', 'Ptprc', 'Csf1r', 'Itgax', 'Ly6c2', 'H2-Aa', 'Marco', 'Mrc1', 'Cd74', 'Fcgr3', 'Cd24a', 'Cd68', 'Cx3cr1', 'Cd14', 'Itgam', 'Spn', 'Cd19', 'Ccr2', 'Emr1')

FeaturePlot(subtiss2, genes_to_check, pt.size = 1, nCol = 2, cols.use = c('grey', 'red'))

```

```{r, echo=FALSE, fig.height=8, fig.width=10}
DotPlot(subtiss, unique(genes_to_check), col.max = 2.5, plot.legend = T, do.return = T) + coord_flip()
```


```{r}
TSNEPlot(object = tiss, do.label = TRUE, pt.size = 0.5, group.by='free_annotation')
```

Myeloid clusters (besides dendritic and two monocyte clusters, where n is sufficently high) do not align with known marker gene expression because of low numbers. Cannot subcluster further!


# Save the Robject for later
When you save the annotated tissue, please give it a name.

```{r}
filename = here('00_data_ingest', '04_tissue_robj_generated', 
                     paste0("facs_", tissue_of_interest, "_seurat_tiss.Robj"))
print(filename)
save(tiss, file=filename)
```

```{r}
# To reload a saved object
# filename = here('00_data_ingest', '04_tissue_robj_generated', 
#                      paste0("facs_", tissue_of_interest, "_seurat_tiss.Robj"))
# load(file=filename)
```

# Export the final metadata

So that Biohub can easily combine all your cell_ontology_classs, please export them as a simple csv.

```{r}
head(tiss@meta.data)
```

```{r}
filename = here('00_data_ingest', '03_tissue_annotation_csv', 
                     paste0(tissue_of_interest, "_facs_annotation.csv"))
write.csv(FetchData(tiss, c('plate.barcode','cell_ontology_class','cell_ontology_id', 'free_annotation', 'tSNE_1', 'tSNE_2')), file=filename)
```

# Figures for Supplement
