---
title: "Liver FACS Notebook"
output:
  pdf_document: default
  html_notebook: default
---

## Preprocess and Cluster

Enter the name of the tissue you want to analyze.

```{r}
tissue_of_interest = "Liver"
library(here)
source(here("00_data_ingest", "02_tissue_analysis_rmd", "boilerplate.R"))
tiss = load_tissue_facs(tissue_of_interest)
```

The loading function above includes basic preprocessing of the gene x cell matrix, including

1. Filtering out cells with fewer than 500 genes or 50,000 reads.
2. Log-normalizing counts for each cell (log(1 + counts per million)).
3. Shifting and scaling each gene to have mean 0 and variance 1.
4. Finding variable genes (those with high dispersion, given their mean).
5. PCA to project the variable genes to 20 dimensions.

We can visualize top genes in each principal component.

```{r, echo=FALSE, fig.height=4, fig.width=8}
PCHeatmap(object = tiss, pc.use = 1:3, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, num.genes = 8)
```

To further reduce variance in the data, we will project onto the top principal components. This has the effect of keeping the major directions of variation in the data and, ideally, supressing noise. A decent rule of thumb is to pick the elbow in the plot below.

```{r}
PCElbowPlot(object = tiss)
```

Choose the number of principal components to use.
```{r}
# Set number of principal components. 
n.pcs = 11
```


The clustering is performed using on a shared-nearest-neighbors graph on the cells. Two cells are connected in the graph of their k-neighborhoods of cells overlap. The (enhanced) Louvain algorithm looks for groups of cells with high modularity--more connections within the group than between groups. The resolution parameter determines the tradeoff between in-group connections and between-group connections in that objective. Higher resolution will give more clusters, lower resolution will give fewer.

```{r}
# Set resolution 
res.used <- 1

tiss <- FindClusters(object = tiss, reduction.type = "pca", dims.use = 1:n.pcs, 
    resolution = res.used, print.output = 0, save.SNN = TRUE)
```

We use tSNE solely to visualize the data.

```{r}
tiss <- RunTSNE(object = tiss, dims.use = 1:n.pcs, seed.use = 10, perplexity=30)
```

```{r}
TSNEPlot(object = tiss, do.label = T, pt.size = 1.2, label.size = 4)
```

## Label clusters using marker genes

Check expression of genes useful for indicating cell type.

hepatocyte: Alb, Ttr, Apoa1, and Serpina1c
endothelial cells: Pecam1, Nrp1, Kdr+ and Oit3+
Kuppfer cells: Emr1, Clec4f, Cd68, Irf7
NK/NKT cells: Zap70, Il2rb, Nkg7, Cxcr6, Klr1c, Gzma
B cells: Cd79a, Cd79b, Cd74 and Cd19

```{r}
genes_hep = c('Alb', 'Ttr', 'Apoa1', 'Serpina1c')
genes_endo = c('Pecam1', 'Nrp1', 'Kdr','Oit3')
genes_kuppfer = c('Emr1', 'Clec4f', 'Cd68', 'Irf7')
genes_nk = c('Zap70', 'Il2rb', 'Nkg7', 'Cxcr6', 'Gzma')
genes_b = c('Cd79a', 'Cd79b', 'Cd74')

genes_all = c(genes_hep, genes_endo, genes_kuppfer, genes_nk, genes_b)
```

In the tSNE plots below, the intensity of each point represents the gene expression, scaled to mean 0 and variance 1 across all cells.

```{r, echo=FALSE, fig.height=24, fig.width=12}
FeaturePlot(tiss, genes_all, pt.size = 3, nCol = 3, cols.use = c("lightgrey", "blue"))
```

Dotplots show, for each cluster and gene, the fraction of cells with at least one read for the gene (circle size) and the average scaled expression for that gene among the cells expressing it (circle color).

```{r, echo=FALSE, fig.height=10, fig.width=6}
DotPlot(tiss, genes_all, plot.legend = T, col.max = 2.5, do.return = T) + coord_flip()
```

The low but nonzero levels of Albumin present in all clusters is consistent with a small amount of leakage, either through physical contamination or index hopping. Nevertheless, the absolute levels of expression confirm a sharp difference between the hepatocyte clusters and the others.

```{r, echo=FALSE, fig.height=3, fig.width=6}
VlnPlot(tiss, 'Alb', use.raw = T, do.return = T)
```

To confirm the identity of a cluster, you can inspect the genes differentially expressed in that cluster compared to the others.

```{r}
clust.markers7 <- FindMarkers(object = tiss, ident.1 = 7, only.pos = TRUE, min.pct = 0.25, thresh.use = 0.25)
```

The top markers for cluster 7 include histocompatibility markers H2-*, consistent with the expression of other B-cell markers seen above.

```{r}
clust.markers7
```

Using the markers, we can confidentaly label the clusters:

```{r}
tiss <- StashIdent(object = tiss, save.name = "cluster.ids")

cluster.ids <- c(0, 1, 2, 3, 4, 5, 6, 7, 8)

free_annotation <- c(
  "endothelial cell",
  "hepatocyte",
  "hepatocyte",
  "hepatocyte",
  "hepatocyte",
  "kuppfer",
  "hepatocyte",
  "B cell",
  "NK/NKT cells")

cell_ontology_class <-c(
  "endothelial cell of hepatic sinusoid",
  "hepatocyte",
  "hepatocyte",
  "hepatocyte",
  "hepatocyte",
  "Kupffer cell",
  "hepatocyte",
  "B cell",
  "natural killer cell")

tiss = stash_annotations(tiss, cluster.ids, free_annotation, cell_ontology_class)
```


## Checking for batch effects

Color by metadata, like plate barcode, to check for batch effects. Here we see that the clusters are segregated by sex, though cell types are mixed within each population.

```{r}
TSNEPlot(object = tiss, do.return = TRUE, group.by = "mouse.id")
```

Every cluster contains cell types from multiple mice.

```{r}
table(FetchData(tiss, c('mouse.id','ident')) %>% droplevels())
```

# Final coloring

Color by cell ontology class on the original tSNE.

```{r}
TSNEPlot(object = tiss, group.by = "cell_ontology_class")
```


# Save the Robject for later

```{r}
filename = here('00_data_ingest', '04_tissue_robj_generated', 
                     paste0("facs_", tissue_of_interest, "_seurat_tiss.Robj"))
print(filename)
save(tiss, file=filename)
```

```{r}
# To reload a saved object
#filename = here('00_data_ingest', '04_tissue_robj_generated',
#                      paste0("facs_", tissue_of_interest, "_seurat_subtiss.Robj"))
#load(file=filename)
```

# Export the final metadata

```{r}
save_annotation_csv(tiss, tissue_of_interest, "facs")
```
